<html>
<head>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<style>
#map {
height: 500px;
width: 100%
}
body {
 font-family: "Times New Roman", Georgia, Serif;
 background-color:   #eef347;
}

</style>

</head>
<script type="text/javascript">
	var beginDate;
	var endDate;

	var num = 0;
	var json_data;
        var pinIconH = 'http://www.googlemapsmarkers.com/v1/G/009900/';
        var markersH = [];
	$.getJSON('https://data.lacity.org/resource/d4vt-q4t5.json?$limit=100&$offset='+num.toString()+'&$order=createddate DESC&$where=requesttype = "Graffiti Removal"', function(data) {
    //data is the JSON string
	json_data = data;
	setCoord(json_data);
	//initMap();
        });

	function showData(){
		var datai = {};
		console.log(json_data.length);
		for(var i=0;i<json_data.length;i++){
			console.log(json_data[i]);
		}
	}


	function setCoord(json_data){
	  var j=0;
	  while(j<json_data.length&&json_data[j].latitude)j++;
	  setNext(j); 
	  function setNext(j){
		if(j<json_data.length){
			var k = j+1;
			while(k<json_data.length&&json_data[k].latitude)k++;

	    		var add = json_data[j].address;
			add = add.replace(/ /g , '+');
	   		add = add.replace(/,/g,'');
			add = add +'+LOS ANGELES';
			
			setTimeout(function(){
			    $.getJSON( 'http://maps.google.com/maps/api/geocode/json?address=' + add,
					function(data){
						setNext(k);
						//console.log(j);
						//console.log(data['results'][0]['formatted_address']);
						json_data[j].latitude = data['results'][0]['geometry']['location']['lat'];
						json_data[j].longitude = data['results'][0]['geometry']['location']['lng'];
						//console.log(j);
					},j,k);

			}, 100,j,k);
		}

		else {
			setTimeout(function(){
				initMap();
				}, 200);
		     }
	  }
	}


      function initMap() {
	console.log('initializing map');
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 10,
          center: {lat: 34.0522, lng: -118.2437}
        });

        var trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);
	markersH = makeMarkers(pinIconH);

	
        function makeMarkers(pinIcon){
	  var markers = [];
	  for (var i=0; i<json_data.length; i++){
            
	     markers.push({
			    data : json_data[i],
			    marker : new google.maps.Marker({
					    position: new google.maps.LatLng(json_data[i].latitude, json_data[i].longitude),
					    visible: false,
					    icon: pinIcon,
					    map: map
					    }),
			   window : new google.maps.InfoWindow(),
			   contentString : '<p><b>request type:  </b>' + json_data[i].requesttype + '<br>' +
	    				   '<b>address:  </b>' + json_data[i].address + '<br>' +
	   				   '<b>police precinct:  </b>' + json_data[i].policeprecinct + '<br>' +
	    				   '<b>createddate:  </b>' + json_data[i].createddate + '<br>' +
	    				   '<b>action taken:  </b>' + json_data[i].actiontaken + '<br>' +
					   '</p>',

			   loaded : false
		});

	      var infowindow = markers[i].window;
	      google.maps.event.addListener(markers[i].marker, 'click', (function (infowindow) {
	             return function () {infowindow.open(map, this);}
	         })(infowindow));

	      markers[i].window.setContent(markers[i].contentString);
	  }
	  return markers
        }
      markersH = reverseOrder(markersH);
      setText();
      document.getElementById("plus").disabled = false;
      document.getElementById("minus").disabled = false;
      beginDate = new Date(markersH[0].data.createddate);
    }



    function reverseOrder(markers){
	var rmarkers=[];
        for(var i=markers.length-1;i>=0;i--){
	    rmarkers.push(markers[i]);
	}
	return rmarkers;
    }


    function setText(){
        var content = "";
	for(var i=0;i<markersH.length;i++){
	    content += markersH[i].contentString;
	}
        document.getElementById('text').innerHTML = content;
    }



    count = 0;

    function showMarkers(){
	if(count < markersH.length){
	    for(var i=0; i<5&&count<markersH.length;i++){
		markersH[count].marker.setVisible(true);
		count++;
	    }
	    document.getElementById('updates').innerHTML = 'Showing '+count+ ' updates';
	    endDate = new Date(markersH[count-1].data.createddate);
	    document.getElementById('small').innerHTML = '<br><br><mark>'+beginDate.toDateString()+' '+beginDate.toLocaleTimeString() + '</mark> to <mark>'+ endDate.toDateString()+' '+endDate.toLocaleTimeString()+'</mark>';
		
	}
    }

    function reduceMarkers(){
	if(count > 0){
	    for(var i=5; i>0&&count>0;i--){
		markersH[count-1].marker.setVisible(false);
		count--;
	    }
	    document.getElementById('updates').innerHTML = 'Showing '+count+ ' updates';
	     if(count==0) document.getElementById('small').innerHTML = '';
	     else {
		endDate = new Date(markersH[count-1].data.createddate);
		document.getElementById('small').innerHTML = '<br><br><mark>'+beginDate.toDateString()+' '+beginDate.toLocaleTimeString() + '</mark> to <mark>'+ endDate.toDateString()+' '+endDate.toLocaleTimeString()+'</mark>';
	     }
	}
    }

</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALZgGws3IIr5O3LcWZTCD3W3IKa0l6YrI">
</script>
<body class="container">
    <div class="row">
        <div class="col-md-9"><img src="cci-logo.png"></div>
        <div class="col-md-3" style="padding-top:17px"><img src="i3_logo.png"></div>
    </div>
    <h2>Latest 100 Graffiti Removal Requests in Los Angeles<small id="small"></small></h2>
    <div> <button id="minus" type="button" onclick="reduceMarkers();" disabled=true >-</button>
	  <button id="plus" type="button" onclick="showMarkers();" disabled=true >+</button>
	</div>
    <label id="updates" for="updates">Showing 0 updates</label>
<div class="row">
    <div class="col-md-9">
	<div id="map"></div>
    </div>
    <div class="col-md-3">
   	 <div id="text" style="overflow-y:scroll; height:500px; padding:10px 10px 10px 10px"> </div>
    </div>
</div>

<div style="height:100px"></div>

</body>
</html>
