<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">

    <style>
       #map {
        height: 500px;
        width: 100%
       }
       body {
	 font-family: Ariel, Helvetica, sans-serif;
       }

    </style>
   
    <script src="map_locs.js">
    </script>
    <script src="mqttws31.js" type="text/javascript"></script>
    <script type="text/javascript">
	
	function createLocs(message,markers,visible){
	    var mess;
	    mess = message.payloadString;
	    var locs = mess.split('\n');
	    locs.pop();
	    console.log(message.destinationName+ ' ' + locs.length);
	    for (var i=0; i<locs.length; i++){
		locs[i] = JSON.parse(locs[i]);
		console.log('>>>'+ locs[i]+'<<<\n');
	    }
	    setMarkers(markers,locs,visible);	    
	}


	// Create a client instance: Broker, Port, Websocket Path, Client ID
	//client = new Paho.MQTT.Client("iot.eclipse.org", Number(80),'/ws',"");
	client = new Paho.MQTT.Client("neptune.usc.edu", Number(3884),"");
	 
	// set callback handlers
	client.onConnectionLost = function (responseObject) {
	    console.log("Connection Lost: "+responseObject.errorMessage);
	}
	 
	client.onMessageArrived = function (message) {
	  //console.log("Message Arrived: "+message.payloadString);
	  
	  if(message.destinationName == 'la/bulky_items'){
	    createLocs(message,markersB,'dispB');
	  }
	  else if(message.destinationName == 'la/dead_animal_removal'){
	    createLocs(message,markersD,'dispD');
	  }
	  else if(message.destinationName == 'la/electronic_waste'){
	    createLocs(message,markersE,'dispE');
	  }
	  else if(message.destinationName == 'la/graffiti_removal'){
	    createLocs(message,markersG,'dispG');
	  }
	  else if(message.destinationName == 'la/homeless_encampment'){
	    createLocs(message,markersH,'dispH');
	  }
	  else if(message.destinationName == 'la/illegal_dumping_pickup'){
	    createLocs(message,markersI,'dispI');
	  }
	  else if(message.destinationName == 'la/metal-household_appliances'){
	    createLocs(message,markersM,'dispM');
	  }
	  else if(message.destinationName == 'la/multiple_streetlight_issue'){
	    createLocs(message,markersMS,'dispMS');
	  }
	  else if(message.destinationName == 'la/report_water_waste'){
	    createLocs(message,markersW,'dispW');
	  }
	  else if(message.destinationName == 'la/single_streetlight_issue'){
	    createLocs(message,markersSS,'dispSS');
	  }
	}
	  
	// Called when the connection is made
	function onConnect(){
	    console.log('Connected!');
	    client.subscribe('la/electronic_waste');
	    client.subscribe('la/bulky_items');
	    client.subscribe('la/dead_animal_removal')
	    client.subscribe('la/electronic_waste')
	    client.subscribe('la/graffiti_removal')
	    client.subscribe('la/homeless_encampment')
	    client.subscribe('la/illegal_dumping_pickup')
	    client.subscribe('la/metal-household_appliances')
	    client.subscribe('la/multiple_streetlight_issue')
	    client.subscribe('la/report_water_waste')
	    client.subscribe('la/single_streetlight_issue')
	}

    var map;

    var pinIconH = 'http://www.googlemapsmarkers.com/v1/H/ADFF2F/';
    var pinIconG = 'http://www.googlemapsmarkers.com/v1/G/009900/';
    var pinIconD = 'http://www.googlemapsmarkers.com/v1/D/ffff00/';
    var pinIconI = 'http://www.googlemapsmarkers.com/v1/I/0000ff/';
    var pinIconE = 'http://www.googlemapsmarkers.com/v1/E/ffa500/';
    var pinIconB = 'http://www.googlemapsmarkers.com/v1/B/ff69b4/';
    var pinIconM = 'http://www.googlemapsmarkers.com/v1/M/ee00ee/';
    var pinIconW = 'http://www.googlemapsmarkers.com/v1/W/87ceeb/';
    var pinIconSS = 'http://www.googlemapsmarkers.com/v1/SS/c0c0c0/';
    var pinIconMS = 'http://www.googlemapsmarkers.com/v1/MS/d2b48c/';
    var pinIconC = 'http://www.googlemapsmarkers.com/v1/C/ff0000/';

    var marker;
    var markersH = [];
    var markersG = [];
    var markersD = [];
    var markersI = [];
    var markersE = [];
    var markersB = [];
    var markersM = [];
    var markersW = [];
    var markersSS = [];
    var markersMS = [];

    function setInputs(){
	document.getElementById('dispH').checked = false;
	document.getElementById('dispH').disabled = true;
	document.getElementById('dispG').checked = false;
	document.getElementById('dispG').disabled = true;
	document.getElementById('dispD').checked = false;
	document.getElementById('dispD').disabled = true;
	document.getElementById('dispI').checked = false;
	document.getElementById('dispI').disabled = true;
	document.getElementById('dispE').checked = false;
	document.getElementById('dispE').disabled = true;
	document.getElementById('dispB').checked = false;
	document.getElementById('dispB').disabled = true;
	document.getElementById('dispM').checked = false;
	document.getElementById('dispM').disabled = true;
	document.getElementById('dispW').checked = false;
	document.getElementById('dispW').disabled = true;
	document.getElementById('dispSS').checked = false;
	document.getElementById('dispSS').disabled = true;
	document.getElementById('dispMS').checked = false;
	document.getElementById('dispMS').disabled = true;
        document.getElementById('showText').selectedIndex = 0;
    }

    function initMap() {
	setInputs();

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: {lat: 34.0522, lng: -118.2437}
        });

        var trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);

	markersB = makeMarkers(pinIconB);
	markersD = makeMarkers(pinIconD);
	markersE = makeMarkers(pinIconE);
	markersG = makeMarkers(pinIconG);
	markersH = makeMarkers(pinIconH);
	markersI = makeMarkers(pinIconI);
	markersM = makeMarkers(pinIconM);
	markersMS = makeMarkers(pinIconMS);
	markersW = makeMarkers(pinIconW);
	markersSS = makeMarkers(pinIconSS);

	function makeMarkers(pinIcon){
	  markers = []
	  for (var i=0; i<20; i++){
	     markers.push({marker : new google.maps.Marker({
				    position: new google.maps.LatLng(34.0522, -118.2437),
				    visible: false,
				    icon: pinIcon,
				    map: map
				    }),
			   window : new google.maps.InfoWindow(),
			   contentString : null,
			   loaded : false
		});

	     var infowindow = markers[i].window;
	     google.maps.event.addListener(markers[i].marker, 'click', (function (infowindow) {
                    return function () {infowindow.open(map, this);}
                })(infowindow));

	  }
	  return markers
        }

	// Connect the client, providing an onConnect callback
	client.connect({
	    onSuccess: onConnect,
    	    userName : 'la_buyer',
    	    password : '90hsi1'

	});
    }

    function enableInputs(visible){
	    document.getElementById('selectText').disabled = false;
	    document.getElementById(visible).disabled = false;
	    if(visible == 'dispH'){
	        document.getElementById('hloc').disabled = false;
	    }
	    if(visible == 'dispD'){
	        document.getElementById('dloc').disabled = false;
	    }
	    if(visible == 'dispG'){
	        document.getElementById('gloc').disabled = false;
	    }
	    if(visible == 'dispI'){
	        document.getElementById('iloc').disabled = false;
	    }
	    if(visible == 'dispE'){
	        document.getElementById('eloc').disabled = false;
	    }
	    if(visible == 'dispB'){
	        document.getElementById('bloc').disabled = false;
	    }
	    if(visible == 'dispM'){
	        document.getElementById('mloc').disabled = false;
	    }
	    if(visible == 'dispW'){
	        document.getElementById('wloc').disabled = false;
	    }
	    if(visible == 'dispSS'){
	        document.getElementById('ssloc').disabled = false;
	    }
	    if(visible == 'dispMS'){
	        document.getElementById('msloc').disabled = false;
	    }
    }

    function setMarkers(markers,loc,visible){
	var text = '';
	if(markers[0].loaded == false){
	    enableInputs(visible);
	}
	for(var i=0; i<loc.length; i++){
            markers[i].contentString = 
            '<p><b>request type:  </b>' + loc[i].requesttype + '<br>' +
            '<b>address:  </b>' + loc[i].address + '<br>' +
            '<b>police precinct:  </b>' + loc[i].policeprecinct + '<br>' +
            '<b>createddate:  </b>' + loc[i].createddate + '<br>' +
            '<b>action taken:  </b>' + loc[i].actiontaken +'</p>'
	    markers[i].marker.setPosition(new google.maps.LatLng(loc[i].lat,loc[i].lng));
	    markers[i].marker.setVisible(document.getElementById(visible).checked);
	    markers[i].window.setContent(markers[i].contentString);
	    markers[i].loaded = true;
	    text += markers[i].contentString;
	}

	if(document.getElementById("showText").selectedIndex > 0){
	    var index = document.getElementById("showText").selectedIndex;
	    if((visible=="dispH"&&index==1) ||
	       (visible=="dispG"&&index==2) ||
	       (visible=="dispD"&&index==3) ||
	       (visible=="dispI"&&index==4) ||
	       (visible=="dispE"&&index==5) ||
	       (visible=="dispB"&&index==6) ||
	       (visible=="dispM"&&index==7) ||
	       (visible=="dispW"&&index==8) ||
	       (visible=="dispSS"&&index==9) ||
	       (visible=="dispMS"&&index==10)) document.getElementById('text').innerHTML = text;
	}
    }

    
    function changeState(id)  {
	var markers = [];

	if(id == "dispH") markers = markersH;
	else if(id == "dispG") markers = markersG;
	else if(id == "dispD") markers = markersD;
	else if(id == "dispI") markers = markersI;
	else if(id == "dispE") markers = markersE;
	else if(id == "dispB") markers = markersB;
	else if(id == "dispM") markers = markersM;
	else if(id == "dispW") markers = markersW;
	else if(id == "dispSS") markers = markersSS;
	else if(id == "dispMS") markers = markersMS;

        for (var i=0; i<markers.length; i++){
	    if(markers[i].loaded == true)
	        markers[i].marker.setVisible(document.getElementById(id).checked);
	}
    }

	function getChoice() {
	    var i = document.getElementById("showText").selectedIndex;
	    switch(i){
		case 0:
			document.getElementById("text").innerHTML = "";
			break;
		case 1:
			setText(markersH);
			break;
		case 2:
			setText(markersG);
			break;
		case 3:
			setText(markersD);
			break;
		case 4:
			setText(markersI);
			break;
		case 5:
			setText(markersE);
			break;
		case 6:
			setText(markersB);
			break;
		case 7:
			setText(markersM);
			break;
		case 8:
			setText(markersW);
			break;
		case 9:
			setText(markersSS);
			break;
		case 10:
			setText(markersMS);
			break;
	    } 
	}

	function setText(markers){
		var content = "";
		for(var i=0; i<markers.length; i++){
		    if(markers[i].contentString != null){
		        content += markers[i].contentString;
		    }
		}
	
		document.getElementById('text').innerHTML = content;
	}

    </script>

  </head>
  <body >
<div><img src="cci-logo.png"></div>
    <h3>The Latest Updates from Los Angeles Open Data - 311 Service Requests</h3>
<div style="width:80%;float:left">
<table>
	<tr>
		<td><input id="dispH" type="checkbox" value="hloc" onChange="changeState('dispH')"/>Homeless Encampment</td>
		<td><input id="dispG" type="checkbox" value="gloc" onChange="changeState('dispG')"/><span>Graffiti Removal</span></td>
		<td><input id="dispD" type="checkbox" value="dloc" onChange="changeState('dispD')"/><span>Dead Animal Removal</span></td>
		<td><input id="dispI" type="checkbox" value="iloc" onChange="changeState('dispI')"/><span>Illegal Dumping Pickup</span></td>
		<td><input id="dispE" type="checkbox" value="eloc" onChange="changeState('dispE')"/><span>Electronic Waste</span></td>
	</tr>

	<tr>
		<td><input id="dispB" type="checkbox" value="bloc" onChange="changeState('dispB')"/><span>Bulky Items</span></td>
		<td><input id="dispM" type="checkbox" value="mloc" onChange="changeState('dispM')"/>Metal/Household Appliances</td>
		<td><input id="dispW" type="checkbox" value="wloc" onChange="changeState('dispW')"/><span>Report Water Waste</span></td>
		<td><input id="dispSS" type="checkbox" value="ssloc" onChange="changeState('dispSS')"/><span>Single Streetlight Issue</span></td>
		<td><input id="dispMS" type="checkbox" value="msloc" onChange="changeState('dispMS')"/><span>Multiple Streetlight Issue</span></td>
	</tr>

</table>
    <div id="map" ></div>
 </div>


<div style="width:17%;float:right">
<div>        
    <select id="showText" name="theText" onChange="getChoice()">
    <option id="selectText" disabled="true" >Select Text</option>
    <option id="hloc" value="hloc" disabled="true">Homeless Encampment</option>
    <option id="gloc" value="gloc" disabled="true">Graffiti Removal</option>
    <option id="dloc" value="dloc" disabled="true">Dead Animal Removal</option>
    <option id="iloc" value="iloc" disabled="true">Illegal Dumping Pickup</option>
    <option id="eloc" value="eloc" disabled="true">Electronic Waste</option>
    <option id="bloc" value="bloc" disabled="true">Bulky Items</option>
    <option id="mloc" value="mloc" disabled="true">Metal/Household Appliances</option>
    <option id="wloc" value="wloc" disabled="true">Report Water Waste</option>
    <option id="ssloc" value="ssloc" disabled="true">Single Streetlight Issue</option>
    <option id="msloc" value="msloc" disabled="true">Multiple Streetlight Issue</option>
    </select> 
</div>
<div id="text" style="overflow-y:scroll; height:500px; padding:10px 10px 10px 10px" ></div> 
</div>



    <!--<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALZgGws3IIr5O3LcWZTCD3W3IKa0l6YrI&callback=initMap">-->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALZgGws3IIr5O3LcWZTCD3W3IKa0l6YrI&callback=initMap">
    </script>
  </body>
</html>
